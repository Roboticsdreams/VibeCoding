{% extends "base.html" %}

{% block title %}Questions - Admin{% endblock %}

{% set show_sidebar = true %}
{% set active_page = 'questions' %}

{% block sidebar %}
{% include "includes/admin_sidebar.html" %}
{% endblock %}

{% block main_content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Question Bank</h1>
            <p class="text-muted"><i class="fas fa-info-circle"></i> All questions with model answers</p>
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                <i class="fas fa-plus"></i> Add Question
            </button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <select class="form-select" id="topicFilter">
                        <option value="">All Topics</option>
                        {% for topic in topics %}
                        <option value="{{ topic.name }}">{{ topic.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="difficultyFilter">
                        <option value="">All Difficulties</option>
                        {% for difficulty in difficulties %}
                        <option value="{{ difficulty.name }}">{{ difficulty.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="answerFilter">
                        <option value="">All Questions</option>
                        <option value="answered">With Model Answers</option>
                        <option value="unanswered">Without Model Answers</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if all_questions %}
            <div class="table-responsive">
                <table class="table table-hover" id="questionsTable">
                    <thead>
                        <tr>
                            <th width="5%">ID</th>
                            <th width="15%">Topic</th>
                            <th width="10%">Difficulty</th>
                            <th width="30%">Question</th>
                            <th width="30%">Model Answer</th>
                            <th width="10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for question in all_questions %}
                        <tr class="question-row" 
                            data-topic="{{ question.topic.name }}" 
                            data-difficulty="{{ question.difficulty.name }}" 
                            data-answered="{{ 'yes' if question.model_answer else 'no' }}">
                            <td>{{ question.id }}</td>
                            <td>
                                <span class="badge bg-primary">{{ question.topic.name }}</span>
                            </td>
                            <td>
                                <span class="badge {% if question.difficulty.name == 'Easy' %}bg-success{% elif question.difficulty.name == 'Medium' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ question.difficulty.name }}
                                </span>
                            </td>
                            <td>{{ question.question_text }}</td>
                            <td>
                                {% if question.model_answer %}
                                {{ question.model_answer|truncate(100) }}
                                {% if question.model_answer|length > 100 %}
                                <button class="btn btn-sm btn-link view-answer" data-bs-toggle="modal" data-bs-target="#answerModal" 
                                        data-question="{{ question.question_text }}" data-answer="{{ question.model_answer }}">
                                    View Full
                                </button>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">No model answer provided</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-question" data-bs-toggle="modal" data-bs-target="#editQuestionModal" 
                                        data-id="{{ question.id }}" 
                                        data-question="{{ question.question_text }}" 
                                        data-answer="{{ question.model_answer }}"
                                        data-topic="{{ question.topic.id }}"
                                        data-difficulty="{{ question.difficulty.id }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-4 text-center">
                <p class="mb-0 text-muted">No questions found in the question bank.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Answer Modal -->
<div class="modal fade" id="answerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Model Answer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 class="fw-bold" id="modalQuestion"></h6>
                <hr>
                <div id="modalAnswer" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Question Modal (placeholder) -->
<div class="modal fade" id="editQuestionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Edit form would go here -->
                <form id="editQuestionForm">
                    <input type="hidden" id="questionId">
                    <div class="mb-3">
                        <label for="questionText" class="form-label">Question</label>
                        <textarea class="form-control" id="questionText" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="modelAnswer" class="form-label">Model Answer</label>
                        <textarea class="form-control" id="modelAnswer" rows="5"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="topicSelect" class="form-label">Topic</label>
                            <select class="form-select" id="topicSelect" required>
                                {% for topic in topics %}
                                <option value="{{ topic.id }}">{{ topic.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="difficultySelect" class="form-label">Difficulty</label>
                            <select class="form-select" id="difficultySelect" required>
                                {% for difficulty in difficulties %}
                                <option value="{{ difficulty.id }}">{{ difficulty.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveQuestion">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Question Modal (placeholder) -->
<div class="modal fade" id="addQuestionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Add form would go here -->
                <form id="addQuestionForm">
                    <div class="mb-3">
                        <label for="newQuestionText" class="form-label">Question</label>
                        <textarea class="form-control" id="newQuestionText" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="newModelAnswer" class="form-label">Model Answer</label>
                        <textarea class="form-control" id="newModelAnswer" rows="5"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="newTopicSelect" class="form-label">Topic</label>
                            <select class="form-select" id="newTopicSelect" required>
                                {% for topic in topics %}
                                <option value="{{ topic.id }}">{{ topic.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newDifficultySelect" class="form-label">Difficulty</label>
                            <select class="form-select" id="newDifficultySelect" required>
                                {% for difficulty in difficulties %}
                                <option value="{{ difficulty.id }}">{{ difficulty.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addQuestion">Add Question</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const topicFilter = document.getElementById('topicFilter');
    const difficultyFilter = document.getElementById('difficultyFilter');
    const answerFilter = document.getElementById('answerFilter');
    const questionRows = document.querySelectorAll('.question-row');
    
    function filterQuestions() {
        const topicValue = topicFilter.value;
        const difficultyValue = difficultyFilter.value;
        const answerValue = answerFilter.value;
        
        questionRows.forEach(row => {
            const topic = row.getAttribute('data-topic');
            const difficulty = row.getAttribute('data-difficulty');
            const hasAnswer = row.getAttribute('data-answered');
            
            const matchesTopic = topicValue === '' || topic === topicValue;
            const matchesDifficulty = difficultyValue === '' || difficulty === difficultyValue;
            const matchesAnswer = answerValue === '' || 
                (answerValue === 'answered' && hasAnswer === 'yes') || 
                (answerValue === 'unanswered' && hasAnswer === 'no');
            
            row.style.display = matchesTopic && matchesDifficulty && matchesAnswer ? '' : 'none';
        });
    }
    
    topicFilter.addEventListener('change', filterQuestions);
    difficultyFilter.addEventListener('change', filterQuestions);
    answerFilter.addEventListener('change', filterQuestions);
    
    // Modal view for long answers
    const viewAnswerBtns = document.querySelectorAll('.view-answer');
    viewAnswerBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('modalQuestion').textContent = this.getAttribute('data-question');
            document.getElementById('modalAnswer').textContent = this.getAttribute('data-answer');
        });
    });
    
    // Edit question modal
    const editButtons = document.querySelectorAll('.edit-question');
    editButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const question = this.getAttribute('data-question');
            const answer = this.getAttribute('data-answer') || '';
            const topicId = this.getAttribute('data-topic');
            const difficultyId = this.getAttribute('data-difficulty');
            
            document.getElementById('questionId').value = id;
            document.getElementById('questionText').value = question;
            document.getElementById('modelAnswer').value = answer;
            document.getElementById('topicSelect').value = topicId;
            document.getElementById('difficultySelect').value = difficultyId;
        });
    });
    
    // These would be connected to API endpoints in a real implementation
    document.getElementById('saveQuestion').addEventListener('click', function() {
        // Simulate saving
        alert('Changes would be saved here (API endpoint not implemented)');
        $('#editQuestionModal').modal('hide');
    });
    
    document.getElementById('addQuestion').addEventListener('click', function() {
        // Simulate adding
        alert('Question would be added here (API endpoint not implemented)');
        $('#addQuestionModal').modal('hide');
    });
});
</script>
{% endblock %}
